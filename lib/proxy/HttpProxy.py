from mitmproxy import ctx
import os
import json
from mitmproxy import tcp

dirname = os.path.dirname(os.path.realpath(__file__)) + "/../../"

class Addon():

    def __init__(self):
        self.url_json = {'plugin': 'proxyURL', 'url' : '', 'req_method' : '', 'resp_code': '', 'request': '', 'response': ''}

    def request(self, flow):
        '''
        Addon used by mitmproxy that store each url in a file
        :param flow:
        :return:
        '''
        self.url_json["url"] = flow.request.pretty_url
        self.url_json["req_method"] = flow.request.method
        self.url_json['request'] = flow.request.text


    def response(self, flow):
        self.url_json['resp_code'] = flow.response.status_code
        self.url_json['response'] = flow.response.text

        with open(f"{dirname}tmp/urls.txt","a") as f:
            ctx.log.info(f"Writing url : {self.url_json['url']}")
            f.write(json.dumps(self.url_json))
            f.write('\n')

addons = [
    Addon()
]