import importlib

from sqlalchemy.orm import sessionmaker, scoped_session

from lib.model import Application
from lib.model.Key import Key
from lib.model.Url import Url
from lib.model.database.Database import Database
from lib.modules.Module import Module

from pathlib import Path

import logging
import glob

import json


class ModuleGeneral(Module):
    stop = True

    def __init__(self, device, application, plugins):
        Module.__init__(self, device, application)
        self.plugins = plugins

    @staticmethod
    def select(path, **kwargs):
        logging.debug('ModuleGeneral:select()')
        if Path(path).is_file():
            return [path]
        else:
            return glob.glob(f"{path}/*.apk")

    def parse(self, message, data):
        """
        Parse the message and call the according function
        :param message:
        :return:
        """
        # if data != None:
        #     print(f"{message} {data}")
        # else:
        #     print(message)
        
        message_json = json.loads(message)

        logging.debug("ModuleGeneral:parse()")

        for plugin in self.plugins:
            plugin.parse(self, message_json, data)

        if message_json['plugin'] == "to_string":
            message = message_json['string']

            if message.startswith("http://") or message.startswith("https://"):
                obj = {"plugin": "url", "url" : message, "stack" : '', "req_method" : ""};
                self.url(obj)
                return
            return

        if (message_json['plugin'] == 'url'):
            self.url(message_json)
            return

        keys_type = ['key', 'iv', 'Instance']
        typeOfMsg = ""
        if (message_json['plugin']) in keys_type:
            typeOfMsg = message_json['plugin']
            self.key(typeOfMsg, data)
            return


    def url(self, url):
        '''
        Add an url to the database
        :param url:
        :return:
        '''
        logging.debug("ModuleGeneral:url()")

        # Create a thread local session
        engine = Database.get_engine()

        session_factory = sessionmaker(bind=engine)
        Session = scoped_session(session_factory)
        session = Session()
        Session.remove()

        url = Url(url)

        # Whitelist Google
        # whitelist = ['0.0.0.0', '172.', '216.58.']
        whitelist = ['0.0.0.0']

        add = True
        if url.ip is not None:
            for i in whitelist:
                if url.ip.startswith(i):
                    add = False

        if add:
            # Fetch application for this session ( could not use self.application
            # because the usage must be thread local )
            application = session.query(Application.Application).get(self.application.id)

            logging.debug(repr(url))

            query = session.query(Url).filter(Url.application_id==self.application.id).filter(Url.scheme==url.scheme).filter(Url.domain==url.domain).filter(Url.uri==url.uri).filter(Url.ip==url.ip).filter(Url.query==url.query).filter(Url.req_method==url.req_method).filter(Url.is_up==url.is_up)

            resultQuery = query.all()

            if len(resultQuery) == 0:
                application.url.append(url)
                session.add(url)
                session.add(application)
            else:
                previous_nb = getattr(url, "nb")
                setattr(resultQuery[0], "nb", previous_nb+1)

            session.commit()


    def key(self, typeOfMsg, key):
        '''
        Add a key to the database
        :param type:
        :param key:
        :return:
        '''
        # Create a thread local session
        engine = Database.get_engine()

        session_factory = sessionmaker(bind=engine)
        Session = scoped_session(session_factory)
        session = Session()
        Session.remove()

        # Fetch application for this session ( could not use self.application
        # because the usage must be thread local )
        application = session.query(Application.Application).get(self.application.id)
        key = Key(typeOfMsg, key.hex())
        logging.debug(repr(key))

        query = session.query(Key).filter(Key.application_id==self.application.id).filter(Key.type==key.type).filter(Key.value==key.value)

        resultQuery = query.all()

        if len(resultQuery) == 0:
            application.key.append(key)
            session.add(key)
            session.add(application)
        # else:
        #     previous_nb = getattr(key, "nb")
        #     print(previous_nb)
        #     print(resultQuery[0])
        #     setattr(resultQuery[0], "nb", previous_nb+1)
        #     print(getattr(resultQuery[0], "nb"))

        session.commit()
