import datetime
import re
import socket
from urllib.parse import urlparse

from sqlalchemy import Column, Integer, String, Boolean, ForeignKey, DateTime

from lib.model.database.Database import Database

import binascii
import base64

Base = Database.get_declarative_base()


class Url(Base):
    __tablename__ = 'url'
    id = Column(Integer, primary_key=True)
    req_method = Column(String)
    scheme = Column(String)
    ip = Column(String)
    domain = Column(String)
    uri = Column(String)
    query = Column(String)
    stacktrace = Column(String)
    is_up = Column(Boolean)
    nb = Column(Integer)
    date = Column(DateTime, default=datetime.datetime.utcnow)
    application_id = Column(Integer, ForeignKey('application.id'))

    def __init__(self, msg_json):
        parsed_url = urlparse(msg_json['url'])
        self.scheme = parsed_url.scheme
        self.req_method = msg_json['req_method']
        self.stacktrace = msg_json['stack']
        self.uri = parsed_url.path
        self.query = parsed_url.query
        self.nb = 1

        if re.match(r'\d+.\d+.\d+.\d+', parsed_url.netloc) :
            self.ip = parsed_url.netloc
            self.domain = 'None'
            self.is_up = self.check_is_up(f"{msg_json['url']}")

        else:
            self.domain = parsed_url.netloc
            try:
                self.ip = socket.gethostbyname(self.domain)
                self.is_up = self.check_is_up(f"{msg_json['url']}")
            except:
                self.is_up = False


    def check_is_up(self,addr):
        try:
            socket.gethostbyaddr(addr)
            return True
        except:
            return False



    def __repr__(self):
        return f'<Url(id={self.id}, scheme="{self.scheme}"' \
            f',ip="{self.ip}", domain="{self.domain}", uri="{self.uri}"' \
            f', is_up="{self.is_up}", date="{self.date}")>'