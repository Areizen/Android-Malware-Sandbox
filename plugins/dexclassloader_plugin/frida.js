var dexclassloader = {
    'id' : '',
    'dexPath' : '',
    'optimizedDirectory' : '',
    'librarySearchPath': '',
    'parent': '',
    'class': ''
}

function dexclass_loader(){
    var DexClassLoader = Java.use("dalvik.system.DexClassLoader");
    var Class = Java.use('java.lang.Class');
    var ClassLoader = Java.use('java.lang.ClassLoader');

    var threadef = Java.use('java.lang.Thread');
    var threadinstance = threadef.$new();

    DexClassLoader.$init.implementation = function(dexPath,optimizedDirectory,librarySearchPath,parent){
        var result = this.$init(dexPath,optimizedDirectory,librarySearchPath,parent);
        dexclassloader['id'] = this.hashCode();
        dexclassloader['dexPath'] = dexPath;
        dexclassloader['optimizedDirectory'] = optimizedDirectory;
        dexclassloader['librarySearchPath'] = librarySearchPath;
        if (parent == null){
            dexclassloader['parent'] = 'null';
        }
        else{
            dexclassloader['parent'] = parent.toString();
        }
        var stack = threadinstance.currentThread().getStackTrace();
        var obj = {"plugin": "dexclassloader", "dexPath": dexclassloader['dexPath'], "optimizedDirectory": dexclassloader['optimizedDirectory'], "librarySearchPath": dexclassloader['librarySearchPath'], "parent": dexclassloader['parent'], "entrypoint": 'NULL', 'stack': Where(stack)};
        send(JSON.stringify(obj));
        return result;
    }

    ClassLoader.loadClass.overload('java.lang.String', 'boolean').implementation = function(name, resolve){
        var result = this.loadClass(name, resolve);
        if (this.hashCode() == dexclassloader['id']){
            dexclassloader['class'] = name;
        }
        return result;
    }

    ClassLoader.loadClass.overload('java.lang.String').implementation = function(name){
        var result = this.loadClass(name);
        if (this.hashCode() == dexclassloader['id']){
            dexclassloader['class'] = name;
        }
        return result;
    }

    var getMethod = ['getDeclaredMethod', 'getMethod'];

    getMethod.forEach(function(method, i) {
        Class[method].overload('java.lang.String', '[Ljava.lang.Class;').implementation = function(name, parameterTypes){

            if (parameterTypes == null){
                var new_parameterTypes = '';
            }
            else{
                var new_parameterTypes = parameterTypes.toString().replace(' ', ', ');
            }

            if (this.getName() == dexclassloader['class']){
                var stack = threadinstance.currentThread().getStackTrace();
                var entrypoint = this.getName() + "." + name + "(" + new_parameterTypes + ")";
                var obj = {"plugin": "dexclassloader", "dexPath": dexclassloader['dexPath'], "optimizedDirectory": dexclassloader['optimizedDirectory'], "librarySearchPath": dexclassloader['librarySearchPath'], "parent": dexclassloader['parent'], "entrypoint": entrypoint, 'stack': Where(stack)};
                send(JSON.stringify(obj));

                //Reset dexclassloader dict
                for (var i = 0; i < dexclassloader.length; i += 1) {
                    dexclassloader[i] = '';
                }
            }
            return this[method](name, parameterTypes);
        }
    });
}

dexclass_loader();