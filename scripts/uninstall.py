#!/usr/bin/python
import frida
import subprocess
import sys

if len(sys.argv) !=2:
    print(f"[-] Usage : python {sys.argv[0]} <package_to_uninstall>")
    sys.exit(-1)

def message(message, data):
    print(message)

device = frida.get_usb_device()


session_gatekeeper =  device.attach("system_server")

# see : https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java?q=DELETE_FAILED_DEVICE_POLICY_MANAGER&ss=android%2Fplatform%2Fsuperproject
script_gatekeeper = session_gatekeeper.create_script("""
Java.perform(function(){
    const PackageManager = Java.use("com.android.server.pm.PackageManagerService")

    PackageManager.isPackageDeviceAdmin.implementation = function(packageName, userId){
        console.log("isPackageDeviceAdmin called !");
        return false;
    }
})
""")
script_gatekeeper.on("message", message)
script_gatekeeper.load()

pid = subprocess.Popen(["adb","uninstall", sys.argv[1]])
pid.wait()